'use strict';var _Mathceil=Math.ceil,_Mathfloor=Math.floor;class RainColumn{constructor(a,b,c){this.index=b,this.applySettings(a),this.frameSkip=1,this.currentRow=0,this.delay=this.getRandom(this.settings.minSpeed,this.settings.maxSpeed),this.delayPos=this.delay,this.isInWindup=!1,(a.alwaysWindup||c)&&(this.isInWindup=!0),this.windupCount=0,this.columnXOffset=a.frontDraw.width*b,this.targetRows=a.frontDraw.rows}check(){return 0<this.delayPos?void--this.delayPos:void(this.draw(),this.currentRow<this.targetRows?(this.currentRow+=this.skipAmount,this.delayPos=this.delay):(this.currentRow=0,this.delay=this.getRandom(this.settings.minSpeed,this.settings.maxSpeed),this.targetRows=this.settings.frontDraw.rows,0===this.delay&&(Math.random()<=this.settings.skipChance?(this.skipAmount=this.getRandom(2,this.settings.frameSkip),this.targetRows+=this.skipAmount):this.skipAmount=1)))}draw(){if(!this.isInWindup)this.spriteCtx.globalAlpha=1,this.fadeCtx.globalAlpha=1;else{const a=this.settings.offsets.windup;this.spriteCtx.globalAlpha=a[this.windupCount],this.fadeCtx.globalAlpha=a[this.windupCount],this.currentRow===this.settings.frontDraw.rows&&(++this.windupCount,this.windupCount===this.settings.windup&&(this.isInWindup=!1))}this.renderFade(),this.renderSprite()}renderFade(){const a=this.settings,b=a.frontDraw,c=a.offsets.fade[this.currentRow];let d=a.fadeHeight;1<this.skipAmount&&(d=a['fadeHeight'+this.skipAmount]);const e=b.width*(this.skipAmount-1);this.fadeCtx.clearRect(this.columnXOffset,c,b.width,d),this.fadeCtx.drawImage(this.fadeBackCtx.canvas,e,0,b.width,d,this.columnXOffset,c,b.width,d)}renderSprite(){const a=this.settings,b=a.frontDraw;let c=_Mathfloor(a.sprite.frameCount/this.skipAmount),d=_Mathfloor(a.sprite.frameCount/this.skipAmount);const e=0===d?0:this.skipAmount-1,f=0===d?1:this.skipAmount,g=[a.spriteSheetIsHorizontal?a.offsets.sprites[this.getRandom(0,c)]:0,a.spriteSheetIsVertical?a.offsets.sprites[this.getRandom(0,d)]:0];this.spriteCtx.clearRect(this.columnXOffset,a.offsets.draw[this.currentRow],b.width,b.height*f),this.spriteCtx.drawImage(this.spriteBackCtx.canvas,g[0],g[1],b.width,b.height*this.skipAmount,this.columnXOffset,a.offsets.draw[this.currentRow],b.width,b.height*this.skipAmount)}getRandom(a,b){return a=_Mathceil(a),b=_Mathfloor(b),_Mathfloor(Math.random()*(b-a))+a}applySettings(a){this.settings=a,this.bgCtx=a.bgCtx,this.spriteCtx=a.spriteCtx,this.fadeCtx=a.fadeCtx,this.spriteBackCtx=a.spriteBackCtx,this.fadeBackCtx=a.fadeBackCtx,this.columnXOffset=a.frontDraw.width*this.index,this.targetRows=a.frontDraw.rows}reset(){this.isInWindup=!0,this.windupCount=0,this.currentRow=0}}
