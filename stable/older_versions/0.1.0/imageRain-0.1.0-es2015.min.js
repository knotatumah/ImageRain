'use strict';var _Mathceil=Math.ceil,_Mathfloor=Math.floor,_createClass=function(){function a(b,c){for(var e,d=0;d<c.length;d++)e=c[d],e.enumerable=e.enumerable||!1,e.configurable=!0,'value'in e&&(e.writable=!0),Object.defineProperty(b,e.key,e)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var ImageRain=function(){function a(b){var c=this;_classCallCheck(this,a),this.settings=b,this.settingsCheck(b)&&(b.controls&&this.setControls(),this.isRunning=!1,b.fastStart&&(this.isRunning=!0),document.getElementById(b.container).addEventListener('click',function(){c.startStop()}),this.canvases={},this.loadSprites())}return _createClass(a,[{key:'updateColumns',value:function updateColumns(){var b=this;this.columns.map(function(c){c.check()}),this.isRunning&&requestAnimationFrame(function(){b.updateColumns()})}},{key:'startStop',value:function startStop(){var b=this;this.isRunning?this.isRunning=!1:(this.isRunning=!0,requestAnimationFrame(function(){b.updateColumns()}))}},{key:'settingsCheck',value:function settingsCheck(){var b=this.settings;return b.hasOwnProperty('container')&&b.hasOwnProperty('backgroundUrl')&&b.hasOwnProperty('spritesUrl')&&b.hasOwnProperty('spriteFrameCount')&&b.hasOwnProperty('spriteFrameScale')?(this.typeCheck(),(!b.hasOwnProperty('scale')||0>=b.scale||isNaN(b.scale))&&(b.scale=16),(!b.hasOwnProperty('fade')||0>b.fade||1<b.fade||isNaN(b.fade))&&(b.fade=0.5),(!b.hasOwnProperty('fadeCount')||0>b.fadeCount||isNaN(b.fadeCount))&&(b.fadeCount=6),(!b.hasOwnProperty('minSpeed')||0>b.minSpeed||isNaN(b.minSpeed))&&(b.minSpeed=5),(!b.hasOwnProperty('maxSpeed')||0>b.maxSpeed||isNaN(b.maxSpeed))&&(b.maxSpeed=0),b.minSpeed<b.maxSpeed&&(b.minSpeed=b.maxSpeed),(!b.hasOwnProperty('windup')||0>b.windup||isNaN(b.windup))&&(b.windup=3),b.hasOwnProperty('alwaysWindup')&&'boolean'==typeof b.alwaysWindup||(b.alwaysWindup=0),(!b.hasOwnProperty('frameSkip')||0>b.frameSkip||isNaN(b.frameSkip))&&(b.frameSkip=2),(!b.hasOwnProperty('skipChance')||0>b.skipChance||isNaN(b.skipChance))&&(b.skipChance=0.3),b.hasOwnProperty('backgroundColor')&&'string'==typeof b.backgroundColor||(b.backgroundColor='#fff'),(!b.hasOwnProperty('spriteCropX')||0>b.spriteCropX||isNaN(b.spriteCropX))&&(b.spriteCropX=0),(!b.hasOwnProperty('spriteCropY')||0>b.spriteCropY||isNaN(b.spriteCropY))&&(b.spriteCropY=0),b.hasOwnProperty('fastStart')&&'boolean'==typeof b.fastStart||(b.fastStart=!1),b.hasOwnProperty('controls')&&'boolean'==typeof b.controls||(b.controls=!1),!0):(console.log('imageRain: Missing parameters! Check for container, backgroundUrl, spritesUrl, spriteFrameCount, and spriteFrameScale'),!1)}},{key:'typeCheck',value:function typeCheck(){var b=this.settings,c=['spriteFrameScale','spriteFrameCount','scale','fade','fadeCount','minSpeed','maxSpeed','windup','frameSkip','skipChance','spriteCropX','spriteCropY'],d=['fastStart','controls'];for(var e in c)b.hasOwnProperty(e)&&(b[e]=+b[e]);for(var e in d)b.hasOwnProperty(e)&&('true'===b[e]?b[e]=!0:'false'===b[e]&&(b[e]=!1))}},{key:'loadSprites',value:function loadSprites(){var b=this,c=this.settings;c.sprites=new Image,c.sprites.src=c.spritesUrl,c.sprites.onload=function(){var d=c.sprites.width/c.spriteFrameScale,e=c.sprites.height/c.spriteFrameScale;c.spriteSheetIsHorizontal=!1,c.spriteSheetIsVertical=!1,1<d&&(c.spriteSheetIsHorizontal=!0),1<e&&(c.spriteSheetIsVertical=!0),b.loadBackground()}}},{key:'loadBackground',value:function loadBackground(){var b=this,c=this.settings;c.backgroundImg=new Image,c.backgroundImg.src=c.backgroundUrl,c.backgroundImg.onload=function(){b.initRain()}}},{key:'initRain',value:function initRain(){var b=this,c=this.settings;c.canvasHeight=c.backgroundImg.height,c.canvasWidth=c.backgroundImg.width;var d=document.getElementById(c.container);d.style.width=c.canvasWidth+'px',d.style.height=c.canvasHeight+'px',c.bgCtx=this.createCanvas('bgLayer',{styles:{zIndex:1},classes:['imageRainLayer']},{props:{width:c.canvasWidth,height:c.canvasHeight}},!0),c.spriteCtx=this.createCanvas('spriteLayer',{styles:{zIndex:2},classes:['imageRainLayer']},{props:{width:c.canvasWidth,height:c.canvasHeight}},!0),c.fadeCtx=this.createCanvas('fadeLayer',{styles:{zIndex:3},classes:['imageRainLayer']},{props:{width:c.canvasWidth,height:c.canvasHeight}},!0),this.createBackground(),this.setSpriteVars(),this.setDrawVars(),this.createSpriteAtlas(),this.createFadeAtlas(),this.settings.offsets={},this.setSpriteOffsets(),this.setDrawOffsets(),this.setFadeOffsets(),this.setWindupOffsets(),this.createColumns(),(c.fastStart=!0)&&requestAnimationFrame(function(){b.updateColumns()})}},{key:'createCanvas',value:function createCanvas(b,c,d,e){var f=document.createElement('canvas'),g=f.getContext('2d');return this.canvases[b]=f,f.id='irCanvas_'+b,f=this.styleCanvas(f,c),g=this.styleCtx(g,d),e&&document.getElementById(this.settings.container).appendChild(f),g}},{key:'styleCanvas',value:function styleCanvas(b,c){var d=this;if(c.hasOwnProperty('styles'))for(var e in c.styles)b.style[e]=c.styles[e];return c.hasOwnProperty('classes')&&c.classes.map(function(e){d.toggleClass(b,e)}),b}},{key:'styleCtx',value:function styleCtx(b,c){if(c.hasOwnProperty('props'))for(var d in c.props)b.canvas[d]=c.props[d];return b}},{key:'createBackground',value:function createBackground(){var b=this.settings,c=b.bgCtx;c.drawImage(b.backgroundImg,0,0,b.backgroundImg.width,b.backgroundImg.height,0,0,c.canvas.width,c.canvas.height)}},{key:'setDrawVars',value:function setDrawVars(){var b=this.settings,c=_Mathfloor(b.canvasHeight/b.scale);b.frontDraw={width:b.scale,height:b.scale,rows:c+b.fadeCount},b.rowsHeight=_Mathfloor(b.canvasHeight/b.scale)*b.frontDraw.height}},{key:'setSpriteVars',value:function setSpriteVars(){var b=this.settings;b.sprite={xScale:b.spriteFrameScale,yScale:b.spriteFrameScale,frameCount:b.spriteFrameCount-1}}},{key:'createSpriteAtlas',value:function createSpriteAtlas(){var b=this.settings,c=b.sprite,d=b.frontDraw,e=d.width,f=d.height;b.spriteSheetIsHorizontal&&(e=d.width*b.spriteFrameCount),b.spriteSheetIsVertical&&(f=d.height*b.spriteFrameCount);var g;b.hasOwnProperty('spriteBackCtx')?(g=b.spriteBackCtx,g.canvas.width=e,g.canvas.height=f,g.clearRect(0,0,g.canvas.width,g.canvas.height)):g=b.spriteBackCtx=this.createCanvas('spriteBack',{},{props:{width:e,height:f}},!1),g.fillStyle=b.backgroundColor;var h=1;b.spriteSheetIsHorizontal&&(h=b.spriteFrameCount);for(var k,j=0;j<h;j++){k=j*c.xScale+b.spriteCropX;for(var l=0;l<b.spriteFrameCount;l++){var m=l*c.yScale+b.spriteCropY,n=c.xScale-b.spriteCropX,o=c.yScale-b.spriteCropY;g.globalCompositeOperation='source-over',g.fillRect(j*d.width,l*d.height,d.width,d.height),g.globalCompositeOperation='xor',g.drawImage(b.sprites,k,m,n,o,j*d.width,d.height*l,d.width,d.height)}}g.globalCompositeOperation='source-over'}},{key:'createFadeAtlas',value:function createFadeAtlas(){var d,b=this.settings,c=b.frontDraw;b.fadeHeight=c.height*(b.fadeCount+this.settings.frameSkip);for(var e=1;e<this.settings.frameSkip;)b['fadeHeight'+(e+1)]=b.fadeHeight+c.height*e,++e;b.hasOwnProperty('fadeBackCtx')?(d=b.fadeBackCtx,this.styleCtx(d,{props:{width:c.width*this.settings.frameSkip,height:b.fadeHeight}}),d.clearRect(0,0,d.canvas.width,d.canvas.height)):d=b.fadeBackCtx=this.createCanvas('fadeBack',{},{props:{width:c.width*this.settings.frameSkip,height:b.fadeHeight}},!1);var f=document.createElement('canvas'),g=f.getContext('2d');g.canvas.width=2*c.width,g.canvas.height=2*c.height,g.fillStyle=this.settings.backgroundColor,g.globalAlpha=b.fade,g.clearRect(0,0,g.canvas.width,g.canvas.height),g.fillRect(0,0,g.canvas.width,g.canvas.height);var h=b.fade/b.fadeCount;d.globalAlpha=b.fade;var j=function fadeIncrements(k){for(var l=0;l<b.fadeCount;l++)d.drawImage(g.canvas,2,2,c.width,c.height,c.width*k,c.height*(l+k),c.width,c.height),d.globalAlpha=b.fade-h*(l+1)};for(j(0),e=1;e<b.frameSkip;e++)d.globalAlpha=b.fade,d.drawImage(g.canvas,2,2,c.width,c.height,c.width*e,0,c.width,c.height*e),j(e)}},{key:'setSpriteOffsets',value:function setSpriteOffsets(){var b=this.settings.frontDraw;this.settings.offsets.sprites=[];for(var c=0;c<this.settings.sprite.frameCount;c++)this.settings.offsets.sprites[c]=b.height*c}},{key:'setDrawOffsets',value:function setDrawOffsets(){var b=this.settings.frontDraw;this.settings.offsets.draw=[];for(var c=b.rows+(this.settings.frameSkip-1),d=0;d<c;d++)this.settings.offsets.draw[d]=b.height*d}},{key:'setFadeOffsets',value:function setFadeOffsets(){var b=this.settings.frontDraw;this.settings.offsets.fade=[];for(var c=b.rows+(this.settings.frameSkip-1),d=b.height*this.settings.fadeCount,e=0;e<c;e++)this.settings.offsets.fade[e]=b.height*e-d}},{key:'setWindupOffsets',value:function setWindupOffsets(){this.settings.frontDraw;this.settings.offsets.windup=[];for(var c=1/(this.settings.windup+1),d=0;d<this.settings.windup;d++)this.settings.offsets.windup[d]=c*(d+1)}},{key:'createColumns',value:function createColumns(){var b=this.settings,c=_Mathceil(b.canvasWidth/b.scale),d=!1;for(this.columns||(this.columns=[],d=!0);this.columns.length<c;)this.columns.push(new RainColumn(b,this.columns.length,d));this.columns.length>c&&this.columns.splice(c,this.columns.length-c)}},{key:'toggleClass',value:function toggleClass(b,c){if(b.classList)b.classList.toggle(c);else{var d=b.className.split(' '),e=d.indexOf(c);0<=e?d.splice(e,1):d.push(c),b.className=d.join(' ')}}},{key:'reset',value:function reset(){var b=this;this.isRunning=!1,requestAnimationFrame(function(){b.columns.map(function(c){c.reset()}),b.settings.spriteCtx.clearRect(0,0,b.settings.spriteCtx.canvas.width,b.settings.spriteCtx.canvas.height),b.settings.fadeCtx.clearRect(0,0,b.settings.fadeCtx.canvas.width,b.settings.fadeCtx.canvas.height)})}},{key:'showHideLayers',value:function showHideLayers(){var b=this,c=[document.getElementById('bgLayer'),document.getElementById('spriteLayer'),document.getElementById('fadeLayer')];c.map(function(d){!0===d.checked?b.styleCanvas(b.canvases[d.id],{styles:{display:'block'}}):b.styleCanvas(b.canvases[d.id],{styles:{display:'none'}})})}},{key:'setControls',value:function setControls(){var b=this,c=this.settings;document.getElementById('bgLayer').addEventListener('click',function(){b.showHideLayers()}),document.getElementById('spriteLayer').addEventListener('click',function(){b.showHideLayers()}),document.getElementById('fadeLayer').addEventListener('click',function(){b.showHideLayers()}),document.getElementById('irBtnApply').addEventListener('click',function(){b.updateSettings()}),document.getElementById('irBtnReset').addEventListener('click',function(){b.reset()});['scale','fade','fadeCount','minSpeed','maxSpeed','windup','backgroundColor','frameSkip','skipChance'].map(function(f){document.getElementById(f).value=c[f]});var e=[document.getElementById('bgLayer'),document.getElementById('spriteLayer'),document.getElementById('fadeLayer')];e.map(function(f){f.checked=!0})}},{key:'updateSettings',value:function updateSettings(){var b=this,c={scale:+document.getElementById('scale').value,fade:+document.getElementById('fade').value,fadeCount:+document.getElementById('fadeCount').value,minSpeed:+document.getElementById('minSpeed').value,maxSpeed:+document.getElementById('maxSpeed').value,windup:+document.getElementById('windup').value,backgroundColor:document.getElementById('backgroundColor').value,frameSkip:+document.getElementById('frameSkip').value,skipChance:+document.getElementById('skipChance').value},d=Object.keys(c);if(d.map(function(g){c[g]===b.settings[g]&&delete c[g]}),this.settings=Object.assign({},this.settings,c),!this.settingsCheck())return void console.log('imageRain: bad or missing parameters on update! Check controls and inputs for errors.');var e={background:this.createBackground(),drawVars:this.setDrawVars(),spriteAtlas:this.createSpriteAtlas(),fadeAtlas:this.createFadeAtlas(),spriteOffsets:this.setSpriteOffsets(),drawOffsets:this.setDrawOffsets(),fadeOffsets:this.setFadeOffsets(),windupOffsets:this.setWindupOffsets(),createColumns:this.createColumns()},f={background:!1,drawVars:!1,spriteAtlas:!1,fadeAtlas:!1,spriteOffsets:!1,drawOffsets:!1,fadeOffsets:!1,windupOffsets:!1,createColumns:!1};d=Object.keys(e),c.hasOwnProperty('highContrast')&&(f.background=!1),(c.hasOwnProperty('spriteCropX')||c.hasOwnProperty('spriteCropY')||c.hasOwnProperty('scale')||c.hasOwnProperty('backgroundColor'))&&(f.spriteAtlas=!0),(c.hasOwnProperty('fade')||c.hasOwnProperty('fadeCount')||c.hasOwnProperty('scale')||c.hasOwnProperty('backgroundColor'))&&(f.fadeAtlas=!1),(c.hasOwnProperty('fadeCount')||c.hasOwnProperty('scale'))&&(f.fadeOffsets=!0),c.hasOwnProperty('scale')&&(f.drawVars=!0,f.drawOffsets=!0,f.spriteOffsets=!0,f.createColumns=!0),d.map(function(g){f[g]&&e[g]}),this.columns.map(function(g){g.applySettings(b.settings)})}}]),a}(),RainColumn=function(){function a(b,c,d){_classCallCheck(this,a),this.index=c,this.applySettings(b),this.frameSkip=1,this.currentRow=0,this.delay=this.getRandom(this.settings.minSpeed,this.settings.maxSpeed),this.delayPos=this.delay,this.isInWindup=!1,(b.alwaysWindup||d)&&(this.isInWindup=!0),this.windupCount=0,this.columnXOffset=b.frontDraw.width*c,this.targetRows=b.frontDraw.rows}return _createClass(a,[{key:'check',value:function check(){return 0<this.delayPos?void--this.delayPos:void(this.draw(),this.currentRow<this.targetRows?(this.currentRow+=this.skipAmount,this.delayPos=this.delay):(this.currentRow=0,this.delay=this.getRandom(this.settings.minSpeed,this.settings.maxSpeed),this.targetRows=this.settings.frontDraw.rows,0===this.delay&&(Math.random()<=this.settings.skipChance?(this.skipAmount=this.getRandom(2,this.settings.frameSkip),this.targetRows+=this.skipAmount):this.skipAmount=1)))}},{key:'draw',value:function draw(){if(!this.isInWindup)this.spriteCtx.globalAlpha=1,this.fadeCtx.globalAlpha=1;else{var b=this.settings.offsets.windup;this.spriteCtx.globalAlpha=b[this.windupCount],this.fadeCtx.globalAlpha=b[this.windupCount],this.currentRow===this.settings.frontDraw.rows&&(++this.windupCount,this.windupCount===this.settings.windup&&(this.isInWindup=!1))}this.renderFade(),this.renderSprite()}},{key:'renderFade',value:function renderFade(){var b=this.settings,c=b.frontDraw,d=b.offsets.fade[this.currentRow],e=b.fadeHeight;1<this.skipAmount&&(e=b['fadeHeight'+this.skipAmount]);var f=c.width*(this.skipAmount-1);this.fadeCtx.clearRect(this.columnXOffset,d,c.width,e),this.fadeCtx.drawImage(this.fadeBackCtx.canvas,f,0,c.width,e,this.columnXOffset,d,c.width,e)}},{key:'renderSprite',value:function renderSprite(){var b=this.settings,c=b.frontDraw,d=_Mathfloor(b.sprite.frameCount/this.skipAmount),e=_Mathfloor(b.sprite.frameCount/this.skipAmount),f=0===e?0:this.skipAmount-1,g=0===e?1:this.skipAmount,h=[b.spriteSheetIsHorizontal?b.offsets.sprites[this.getRandom(0,d)]:0,b.spriteSheetIsVertical?b.offsets.sprites[this.getRandom(0,e)]:0];this.spriteCtx.clearRect(this.columnXOffset,b.offsets.draw[this.currentRow],c.width,c.height*g),this.spriteCtx.drawImage(this.spriteBackCtx.canvas,h[0],h[1],c.width,c.height*this.skipAmount,this.columnXOffset,b.offsets.draw[this.currentRow],c.width,c.height*this.skipAmount)}},{key:'getRandom',value:function getRandom(b,c){return b=_Mathceil(b),c=_Mathfloor(c),_Mathfloor(Math.random()*(c-b))+b}},{key:'applySettings',value:function applySettings(b){this.settings=b,this.bgCtx=b.bgCtx,this.spriteCtx=b.spriteCtx,this.fadeCtx=b.fadeCtx,this.spriteBackCtx=b.spriteBackCtx,this.fadeBackCtx=b.fadeBackCtx,this.columnXOffset=b.frontDraw.width*this.index,this.targetRows=b.frontDraw.rows}},{key:'reset',value:function reset(){this.isInWindup=!0,this.windupCount=0,this.currentRow=0}}]),a}();
